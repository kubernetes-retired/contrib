#! /bin/bash

function genindex {
  INDEX=""
  for i in $(ls -1 $1); do
      # If this is a directory, link to its index.html. If it's a non-index.html
      # file, link directly to it. Index.html is autogenerated and shouldn't
      # show up in filesystem view.
      if [ -d "$1/$i" ]; then
        SED="s/^.*/ <td\>\<a\ href=\"&\/index.html\"\>&\<\\/a\>\<\\/td\>/"
      elif [ $(echo $i | grep "index.html") ]; then
	continue
      else
        SED="s/^.*/ <td\>\<a\ href=\"&\"\>&\<\\/a\>\<\\/td\>/"
      fi
      INDEX+=`echo $i | sed "$SED"`
  done
  echo "<!DOCTYPE html>
<html>
<head>
<title>NGINX static content webserver.</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<p>You are browsing static assets</p>
$INDEX
</body>
</html>" > $1/index.html
}

echo [`date`] Generating site index rooted at $1
for d in $(find ${1} -type d); do
  genindex $d
done
